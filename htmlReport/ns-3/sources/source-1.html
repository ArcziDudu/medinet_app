


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > AppointmentRestController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.medinet.api.controller.rest</a>
</div>

<h1>Coverage Summary for Class: AppointmentRestController (com.medinet.api.controller.rest)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AppointmentRestController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95.7%
  </span>
  <span class="absValue">
    (66/69)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.medinet.api.controller.rest;
&nbsp;
&nbsp;import com.medinet.api.dto.AppointmentDto;
&nbsp;import com.medinet.api.dto.CalendarDto;
&nbsp;import com.medinet.api.dto.RequestDto;
&nbsp;import com.medinet.business.services.AppointmentService;
&nbsp;import com.medinet.business.services.CalendarService;
&nbsp;import com.medinet.business.services.DoctorService;
&nbsp;import com.medinet.business.services.PatientService;
&nbsp;import com.medinet.infrastructure.entity.DoctorEntity;
&nbsp;import com.medinet.infrastructure.repository.mapper.AppointmentMapper;
&nbsp;import com.medinet.infrastructure.repository.mapper.DoctorMapper;
&nbsp;import com.medinet.infrastructure.repository.mapper.PatientMapper;
&nbsp;import io.swagger.v3.oas.annotations.Operation;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import io.swagger.v3.oas.annotations.media.Schema;
&nbsp;import io.swagger.v3.oas.annotations.responses.ApiResponse;
&nbsp;import io.swagger.v3.oas.annotations.responses.ApiResponses;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import org.springframework.http.MediaType;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;import java.time.DayOfWeek;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalTime;
&nbsp;import java.time.OffsetDateTime;
&nbsp;import java.util.Objects;
&nbsp;
&nbsp;@RestController
<b class="fc">&nbsp;@AllArgsConstructor</b>
&nbsp;@RequestMapping(AppointmentRestController.API_APPOINTMENT)
&nbsp;public class AppointmentRestController {
&nbsp;    public static final String API_APPOINTMENT = &quot;/api/appointment&quot;;
&nbsp;    public static final String API_APPOINTMENT_NEW = &quot;/new&quot;;
&nbsp;    public static final String API_APPOINTMENT_FIND_BY_ID = &quot;/find/{appointmentId}&quot;;
&nbsp;    public static final String API_APPOINTMENT_DELETE = &quot;/{appointmentId}&quot;;
&nbsp;    public static final String API_APPOINTMENT_FIND_ALL_BY_STATUS = &quot;/all/{status}&quot;;
&nbsp;    public static final String API_APPOINTMENT_FIND_ALL_BY_STATUS_AND_DOCTOR_ID = &quot;/all/{status}/{doctorId}&quot;;
&nbsp;    public static final String API_APPOINTMENT_UPDATE_MESSAGE = &quot;/{appointmentId}&quot;;
&nbsp;
&nbsp;    private final AppointmentService appointmentService;
&nbsp;    private final AppointmentMapper appointmentMapper;
&nbsp;    private final PatientService patientService;
&nbsp;    private final PatientMapper patientMapper;
&nbsp;    private final DoctorService doctorService;
&nbsp;    private final DoctorMapper doctorMapper;
&nbsp;    private final CalendarService calendarService;
&nbsp;
&nbsp;
&nbsp;    @PostMapping(value = API_APPOINTMENT_NEW, produces = MediaType.APPLICATION_JSON_VALUE)
&nbsp;    @Operation(summary = &quot;Create an appointment&quot;,
&nbsp;            description = &quot;Create an appointment based on the provided details&quot;)
&nbsp;    public ResponseEntity&lt;?&gt; createAppointment(@RequestBody
&nbsp;                                               @Schema(description = &quot;Appointment request&quot;)
&nbsp;                                               RequestDto requestDto) {
<b class="fc">&nbsp;        LocalTime visitTime = requestDto.getTimeOfVisit();</b>
&nbsp;
<b class="fc">&nbsp;        LocalTime minAllowedTime = LocalTime.of(8, 0);</b>
<b class="fc">&nbsp;        LocalTime maxAllowedTime = LocalTime.of(16, 0);</b>
<b class="fc">&nbsp;        LocalDate currentDate = LocalDate.now();</b>
<b class="fc">&nbsp;        LocalDate appointmentDate = requestDto.getDateOfAppointment();</b>
<b class="fc">&nbsp;        boolean appointmentExist</b>
<b class="fc">&nbsp;                = appointmentService.existByDateAndTimeOfVisit(requestDto.getDateOfAppointment(), requestDto.getTimeOfVisit());</b>
<b class="fc">&nbsp;        if (currentDate.plusWeeks(2).isBefore(appointmentDate)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;Invalid appointment date - you cannot schedule an appointment more than two weeks from today!&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (currentDate.plusDays(1).isAfter(appointmentDate)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;Invalid appointment date - you cannot schedule an appointment earlier than tomorrow!&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (appointmentDate.getDayOfWeek() == DayOfWeek.SATURDAY || appointmentDate.getDayOfWeek() == DayOfWeek.SUNDAY) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;Invalid appointment date - you cannot schedule an appointment on the weekend!&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (visitTime.isBefore(minAllowedTime) || visitTime.isAfter(maxAllowedTime)) {</b>
<b class="nc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="nc">&nbsp;                    .body(&quot;Invalid appointment time!&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (appointmentExist) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;The selected time slot is already booked!&quot;);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            DoctorEntity doctorEntity = doctorMapper.mapFromDto(doctorService.findDoctorById(requestDto.getDoctorId()));</b>
<b class="fc">&nbsp;            CalendarDto calendar = calendarService</b>
<b class="fc">&nbsp;                    .findByDoctorIdAndDateOfAppointment(doctorEntity, requestDto.getDateOfAppointment());</b>
&nbsp;
<b class="fc">&nbsp;            AppointmentDto appointment = createAppointmentDto(requestDto, calendar);</b>
&nbsp;
<b class="fc">&nbsp;            appointmentService.processAppointment(appointmentMapper.mapFromDto(appointment));</b>
<b class="fc">&nbsp;            return ResponseEntity.ok().build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private AppointmentDto createAppointmentDto(RequestDto requestDto, CalendarDto calendar) {
<b class="fc">&nbsp;        return AppointmentDto.builder()</b>
<b class="fc">&nbsp;                .dateOfAppointment(requestDto.getDateOfAppointment())</b>
<b class="fc">&nbsp;                .timeOfVisit(requestDto.getTimeOfVisit())</b>
<b class="fc">&nbsp;                .patient(patientMapper.mapFromDto(patientService.findByEmail(requestDto.getEmail())))</b>
<b class="fc">&nbsp;                .doctor(doctorMapper.mapFromDto(doctorService.findDoctorById(requestDto.getDoctorId())))</b>
<b class="fc">&nbsp;                .issueInvoice(OffsetDateTime.now())</b>
<b class="fc">&nbsp;                .calendarId(calendar.getCalendarId())</b>
<b class="fc">&nbsp;                .status(&quot;pending&quot;)</b>
<b class="fc">&nbsp;                .UUID(appointmentService.getVisitNumber())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(value = API_APPOINTMENT_FIND_BY_ID)
&nbsp;    @Operation(summary = &quot;Get appointment by ID&quot;,
&nbsp;            description = &quot;Retrieve information about an appointment based on its ID&quot;)
&nbsp;    @ApiResponses(value = {
&nbsp;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Appointment found&quot;),
&nbsp;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Appointment not found&quot;)
&nbsp;    })
&nbsp;    public ResponseEntity&lt;AppointmentDto&gt; AppointmentById(@PathVariable Integer appointmentId) {
&nbsp;
<b class="fc">&nbsp;        if (Objects.isNull(appointmentId)) {</b>
<b class="nc">&nbsp;            return ResponseEntity.notFound().build();</b>
&nbsp;        }
<b class="fc">&nbsp;        AppointmentDto appointment = appointmentService.findById(appointmentId);</b>
&nbsp;
<b class="fc">&nbsp;        return ResponseEntity.ok(appointment);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @GetMapping(value = API_APPOINTMENT_FIND_ALL_BY_STATUS)
&nbsp;    @Operation(summary = &quot;Get appointments by status&quot;,
&nbsp;            description = &quot;Retrieve appointments based on the specified status&quot;)
&nbsp;    @ApiResponses(value = {
&nbsp;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Appointments found&quot;),
&nbsp;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid status provided&quot;)
&nbsp;    })
&nbsp;    public ResponseEntity&lt;?&gt; AppointmentsByStatus(@PathVariable String status) {
<b class="fc">&nbsp;        if (!status.equals(&quot;done&quot;) &amp;&amp; !status.equals(&quot;pending&quot;) &amp;&amp; !status.equals(&quot;upcoming&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;Invalid appointment status&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return ResponseEntity.ok(appointmentService.findAllAppointmentsByStatus(status));</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @GetMapping(value = API_APPOINTMENT_FIND_ALL_BY_STATUS_AND_DOCTOR_ID)
&nbsp;    @Operation(summary = &quot;Get appointments by status and doctor ID&quot;,
&nbsp;            description = &quot;Retrieve appointments based on the specified status and doctor ID&quot;)
&nbsp;    @ApiResponses(value = {
&nbsp;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Appointments found&quot;),
&nbsp;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid status provided&quot;)
&nbsp;    })
&nbsp;    public ResponseEntity&lt;?&gt; AppointmentsByStatusAndDoctorId(
&nbsp;            @PathVariable @Parameter(description = &quot;Appointment status&quot;) String status,
&nbsp;            @PathVariable @Parameter(description = &quot;Doctor ID&quot;) Integer doctorId
&nbsp;    ) {
<b class="fc">&nbsp;        if (!status.equals(&quot;done&quot;) &amp;&amp; !status.equals(&quot;pending&quot;) &amp;&amp; !status.equals(&quot;upcoming&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;Invalid appointment status&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return ResponseEntity.ok(appointmentService.findAllAppointmentsByStatusAndDoctorID(status, doctorId));</b>
&nbsp;    }
&nbsp;
&nbsp;    @PatchMapping(API_APPOINTMENT_UPDATE_MESSAGE)
&nbsp;    @Operation(summary = &quot;Update appointment message&quot;, description = &quot;Update the message for an appointment&quot;)
&nbsp;    @ApiResponses(value = {
&nbsp;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Appointment message updated&quot;),
&nbsp;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid appointment ID or message provided&quot;)
&nbsp;    })
&nbsp;    public ResponseEntity&lt;?&gt; updateAppointmentMessage(
&nbsp;            @PathVariable @Parameter(description = &quot;Appointment ID&quot;) Integer appointmentId,
&nbsp;            @RequestBody @Schema(description = &quot;New appointment message&quot;) String message
&nbsp;    ) {
<b class="fc">&nbsp;        AppointmentDto appointmentCheck = appointmentService.findById(appointmentId);</b>
<b class="fc">&nbsp;        if (appointmentCheck.getStatus().equals(&quot;done&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;You can not modify appointment with status done!&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (appointmentCheck.getStatus().equals(&quot;upcoming&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest()</b>
<b class="fc">&nbsp;                    .body(&quot;You can not modify appointment with status upcoming!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        appointmentService.approveAppointment(appointmentId, message);</b>
<b class="fc">&nbsp;        return ResponseEntity.ok().build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @DeleteMapping(API_APPOINTMENT_DELETE)
&nbsp;    @Operation(summary = &quot;Delete appointment&quot;, description = &quot;Delete an appointment by ID&quot;)
&nbsp;    @ApiResponses(value = {
&nbsp;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Appointment deleted&quot;),
&nbsp;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid appointment ID or cannot delete the appointment&quot;)
&nbsp;    })
&nbsp;    public ResponseEntity&lt;?&gt; deleteAppointment(
&nbsp;            @PathVariable @Parameter(description = &quot;Appointment ID&quot;) Integer appointmentId
&nbsp;    ) {
<b class="fc">&nbsp;        AppointmentDto appointment = appointmentService.findById(appointmentId);</b>
<b class="fc">&nbsp;        if (Objects.isNull(appointment)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;Appointment with the provided ID does not exist&quot;);</b>
<b class="fc">&nbsp;        } else if (Objects.equals(appointment.getStatus(), &quot;pending&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;Cannot cancel an appointment that has already taken place&quot;);</b>
<b class="fc">&nbsp;        } else if (Objects.equals(appointment.getStatus(), &quot;done&quot;)) {</b>
<b class="fc">&nbsp;            return ResponseEntity.badRequest().body(&quot;Cannot cancel an appointment that has already taken place&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        Integer calendarId = appointment.getCalendarId();</b>
<b class="fc">&nbsp;        LocalTime timeOfVisit = appointment.getTimeOfVisit();</b>
<b class="fc">&nbsp;        appointmentService.processRemovingAppointment(appointmentId, timeOfVisit, calendarId);</b>
<b class="fc">&nbsp;        return ResponseEntity.ok().build();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-08-07 14:30</div>
</div>
</body>
</html>
